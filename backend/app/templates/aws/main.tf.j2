# Generated by CloudGraph IDE
provider "aws" {
  region = "{{ region | default('us-east-1') }}"
}

{# --- Data Sources --- #}
{% if ec2_instances %}
{# Only include default AMI lookup if no specific AMI ID is provided #}
{% set needs_default_ami = ec2_instances | selectattr('data.amiId', 'undefined') | list | length > 0 %}
{% if needs_default_ami %}
data "aws_ami" "ubuntu" {
  most_recent = true
  owners      = ["099720109477"] # Canonical

  filter {
    name   = "name"
    values = ["ubuntu/images/hvm-ssd/ubuntu-jammy-22.04-amd64-server-*"]
  }

  filter {
    name   = "virtualization-type"
    values = ["hvm"]
  }
}
{% endif %}
{% endif %}

{# --- 1. VPCs --- #}
{% for vpc in vpcs %}
resource "aws_vpc" "{{ vpc.id | sanitize }}" {
  cidr_block           = "{{ vpc.data.cidr | default('10.0.0.0/16') }}"
  enable_dns_hostnames = {{ vpc.data.enableDnsHostnames | default('true') | lower }}

  tags = {
    Name = "{{ vpc.data.label }}"
  }
}
{% endfor %}

{# --- 2. Subnets --- #}
{% for subnet in subnets %}
resource "aws_subnet" "{{ subnet.id | sanitize }}" {
  vpc_id                  = aws_vpc.{{ subnet.parentNode | sanitize }}.id
  cidr_block              = "{{ subnet.data.cidr | default('10.0.1.0/24') }}"
  availability_zone       = "{{ subnet.data.az | default(region ~ 'a') }}"
  map_public_ip_on_launch = {{ subnet.data.mapPublicIp | default('false') | lower }}

  tags = {
    Name = "{{ subnet.data.label }}"
  }
}
{% endfor %}

{# --- 3. Security Groups (EC2) --- #}
{% for instance in instances %}
{% if instance.data.securityRules %}
resource "aws_security_group" "sg_{{ instance.id | sanitize }}" {
  name        = "sg-{{ instance.data.label | sanitize }}"
  description = "Auto-generated SG for {{ instance.data.label }}"
  vpc_id      = aws_vpc.{{ instance.vpc_id | sanitize }}.id

  {% for rule in instance.data.securityRules %}
  ingress {
    from_port   = {{ rule.port }}
    to_port     = {{ rule.port }}
    protocol    = "{{ rule.protocol | default('tcp') }}"
    cidr_blocks = ["{{ rule.cidr | default('0.0.0.0/0') }}"]
    {% if rule.description %}
    description = "{{ rule.description }}"
    {% endif %}
  }
  {% endfor %}

  egress {
    from_port   = 0
    to_port     = 0
    protocol    = "-1"
    cidr_blocks = ["0.0.0.0/0"]
  }

  tags = {
    Name = "sg-{{ instance.data.label }}"
  }
}
{% endif %}
{% endfor %}

{# --- 4. EC2 Instances (Enhanced) --- #}
{% for instance in instances %}
resource "aws_instance" "{{ instance.id | sanitize }}" {
  {# AMI - use specific ID if provided, otherwise use data source #}
  {% if instance.data.amiId and instance.data.amiId.startswith('ami-') %}
  ami = "{{ instance.data.amiId }}"
  {% else %}
  ami = data.aws_ami.ubuntu.id
  {% endif %}

  instance_type = "{{ instance.data.instanceType | default('t3.micro') }}"
  subnet_id     = aws_subnet.{{ instance.parentNode | sanitize }}.id

  {% if instance.data.keyName %}
  key_name = "{{ instance.data.keyName }}"
  {% endif %}

  {% if instance.data.securityRules %}
  vpc_security_group_ids = [aws_security_group.sg_{{ instance.id | sanitize }}.id]
  {% endif %}

  {# Network Configuration #}
  {% if instance.data.associatePublicIp is defined %}
  associate_public_ip_address = {{ instance.data.associatePublicIp | lower }}
  {% endif %}

  {% if instance.data.privateIp %}
  private_ip = "{{ instance.data.privateIp }}"
  {% endif %}

  {# Storage Configuration #}
  {% if instance.data.rootVolumeSize or instance.data.rootVolumeType or instance.data.rootVolumeEncrypted %}
  root_block_device {
    volume_size           = {{ instance.data.rootVolumeSize | default(8) }}
    volume_type           = "{{ instance.data.rootVolumeType | default('gp3') }}"
    encrypted             = {{ instance.data.rootVolumeEncrypted | default('false') | lower }}
    delete_on_termination = true
  }
  {% endif %}

  tags = {
    Name = "{{ instance.data.label }}"
  }
}
{% endfor %}

{# --- 5. S3 Buckets --- #}
{% for bucket in buckets %}
resource "aws_s3_bucket" "{{ bucket.id | sanitize }}" {
  bucket        = "{{ bucket.data.label | sanitize }}-{{ bucket.id[-6:] | sanitize }}"
  force_destroy = {{ bucket.data.forceDestroy | default('false') | lower }}

  tags = {
    Name = "{{ bucket.data.label }}"
  }
}

{% if bucket.data.versioning %}
resource "aws_s3_bucket_versioning" "ver_{{ bucket.id | sanitize }}" {
  bucket = aws_s3_bucket.{{ bucket.id | sanitize }}.id
  versioning_configuration {
    status = "Enabled"
  }
}
{% endif %}
{% endfor %}

{# --- 6. RDS Databases (Enhanced) --- #}
{% for rds in rds_instances %}
# RDS requires a Subnet Group to exist inside a VPC
resource "aws_db_subnet_group" "grp_{{ rds.id | sanitize }}" {
  name       = "grp-{{ rds.data.label | sanitize }}"
  subnet_ids = [aws_subnet.{{ rds.parentNode | sanitize }}.id]

  tags = {
    Name = "Subnet group for {{ rds.data.label }}"
  }
}

resource "aws_db_instance" "{{ rds.id | sanitize }}" {
  identifier        = "{{ rds.data.label | sanitize }}"
  allocated_storage = {{ rds.data.allocatedStorage | default(20) }}

  {# Database Configuration #}
  db_name  = "{{ rds.data.dbName | default('mydb') }}"
  engine   = "{{ rds.data.engine | default('mysql') }}"
  {% if rds.data.engineVersion %}
  engine_version = "{{ rds.data.engineVersion }}"
  {% else %}
  {# Default versions based on engine #}
  {% if rds.data.engine == 'postgres' %}
  engine_version = "15"
  {% elif rds.data.engine == 'mariadb' %}
  engine_version = "10.11"
  {% else %}
  engine_version = "8.0"
  {% endif %}
  {% endif %}

  instance_class = "{{ rds.data.instanceClass | default('db.t3.micro') }}"
  username       = "{{ rds.data.username | default('admin') }}"
  password       = "{{ rds.data.password | default('ChangeMe123!') }}"

  {# Network Configuration #}
  db_subnet_group_name = aws_db_subnet_group.grp_{{ rds.id | sanitize }}.name
  publicly_accessible  = {{ rds.data.publiclyAccessible | default('false') | lower }}
  {% if rds.data.port %}
  port = {{ rds.data.port }}
  {% endif %}

  {# Storage Configuration #}
  storage_type      = "{{ rds.data.storageType | default('gp2') }}"
  {% if rds.data.storageType == 'io1' and rds.data.iops %}
  iops              = {{ rds.data.iops }}
  {% endif %}
  storage_encrypted = {{ rds.data.storageEncrypted | default('false') | lower }}

  {# Backup Configuration #}
  {% if rds.data.backupRetentionPeriod is defined %}
  backup_retention_period = {{ rds.data.backupRetentionPeriod }}
  {% else %}
  backup_retention_period = 7
  {% endif %}
  {% if rds.data.backupWindow %}
  preferred_backup_window = "{{ rds.data.backupWindow }}"
  {% endif %}

  {# High Availability #}
  multi_az = {{ rds.data.multiAz | default('false') | lower }}

  {# Deletion Settings #}
  skip_final_snapshot = {{ rds.data.skipFinalSnapshot | default('true') | lower }}
  {% if not rds.data.skipFinalSnapshot %}
  final_snapshot_identifier = "{{ rds.data.label | sanitize }}-final-snapshot"
  {% endif %}

  tags = {
    Name = "{{ rds.data.label }}"
  }
}
{% endfor %}

{% if eks_clusters %}
{# --- 7. EKS IAM Roles --- #}
# EKS Cluster Role
resource "aws_iam_role" "eks_cluster" {
  name = "eks-cluster-role"
  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [{
      Effect = "Allow"
      Principal = { Service = "eks.amazonaws.com" }
      Action = "sts:AssumeRole"
    }]
  })
}

resource "aws_iam_role_policy_attachment" "eks_cluster_policy" {
  role       = aws_iam_role.eks_cluster.name
  policy_arn = "arn:aws:iam::aws:policy/AmazonEKSClusterPolicy"
}

# EKS Node Role
resource "aws_iam_role" "eks_nodes" {
  name = "eks-node-role"
  assume_role_policy = jsonencode({
    Version = "2012-10-17"
    Statement = [{
      Effect = "Allow"
      Principal = { Service = "ec2.amazonaws.com" }
      Action = "sts:AssumeRole"
    }]
  })
}

resource "aws_iam_role_policy_attachment" "eks_worker_node_policy" {
  role       = aws_iam_role.eks_nodes.name
  policy_arn = "arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy"
}

resource "aws_iam_role_policy_attachment" "eks_cni_policy" {
  role       = aws_iam_role.eks_nodes.name
  policy_arn = "arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy"
}

resource "aws_iam_role_policy_attachment" "eks_container_registry" {
  role       = aws_iam_role.eks_nodes.name
  policy_arn = "arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly"
}

{# --- 8. EKS Clusters --- #}
{% for cluster in eks_clusters %}
resource "aws_eks_cluster" "{{ cluster.data.label | sanitize }}" {
  name     = "{{ cluster.data.label }}"
  version  = "{{ cluster.data.version | default('1.29') }}"
  role_arn = aws_iam_role.eks_cluster.arn

  vpc_config {
    subnet_ids = [aws_subnet.{{ cluster.subnet_id | sanitize }}.id]
    endpoint_public_access  = {{ cluster.data.endpointPublicAccess | default(true) | lower }}
    endpoint_private_access = {{ cluster.data.endpointPrivateAccess | default(false) | lower }}
  }

  depends_on = [aws_iam_role_policy_attachment.eks_cluster_policy]

  tags = {
    Name = "{{ cluster.data.label }}"
  }
}
{% endfor %}

{# --- 9. EKS Node Groups --- #}
{% if eks_node_groups %}
{% for ng in eks_node_groups %}
resource "aws_eks_node_group" "{{ ng.data.label | sanitize }}" {
  cluster_name    = aws_eks_cluster.{{ ng.cluster_id | sanitize }}.name
  node_group_name = "{{ ng.data.label }}"
  node_role_arn   = aws_iam_role.eks_nodes.arn
  subnet_ids      = [{% for sid in ng.subnet_ids %}aws_subnet.{{ sid | sanitize }}.id{% if not loop.last %}, {% endif %}{% endfor %}]

  scaling_config {
    desired_size = {{ ng.data.desiredSize | default(2) }}
    min_size     = {{ ng.data.minSize | default(1) }}
    max_size     = {{ ng.data.maxSize | default(4) }}
  }

  instance_types = {{ ng.data.instanceTypes | default(["t3.medium"]) | tojson }}
  capacity_type  = "{{ ng.data.capacityType | default('ON_DEMAND') }}"
  disk_size      = {{ ng.data.diskSize | default(20) }}
  ami_type       = "{{ ng.data.amiType | default('AL2_x86_64') }}"

  depends_on = [
    aws_iam_role_policy_attachment.eks_worker_node_policy,
    aws_iam_role_policy_attachment.eks_cni_policy,
    aws_iam_role_policy_attachment.eks_container_registry,
  ]

  tags = {
    Name = "{{ ng.data.label }}"
  }
}
{% endfor %}
{% endif %}

{# --- 10. EKS Add-ons --- #}
{% for cluster in eks_clusters %}
{% if cluster.data.addonVpcCni is not defined or cluster.data.addonVpcCni %}
resource "aws_eks_addon" "{{ cluster.data.label | sanitize }}_vpc_cni" {
  cluster_name = aws_eks_cluster.{{ cluster.data.label | sanitize }}.name
  addon_name   = "vpc-cni"
}
{% endif %}
{% if cluster.data.addonCoreDns is not defined or cluster.data.addonCoreDns %}
resource "aws_eks_addon" "{{ cluster.data.label | sanitize }}_coredns" {
  cluster_name = aws_eks_cluster.{{ cluster.data.label | sanitize }}.name
  addon_name   = "coredns"
}
{% endif %}
{% if cluster.data.addonKubeProxy is not defined or cluster.data.addonKubeProxy %}
resource "aws_eks_addon" "{{ cluster.data.label | sanitize }}_kube_proxy" {
  cluster_name = aws_eks_cluster.{{ cluster.data.label | sanitize }}.name
  addon_name   = "kube-proxy"
}
{% endif %}
{% if cluster.data.addonEbsCsi %}
resource "aws_eks_addon" "{{ cluster.data.label | sanitize }}_ebs_csi" {
  cluster_name = aws_eks_cluster.{{ cluster.data.label | sanitize }}.name
  addon_name   = "aws-ebs-csi-driver"
}
{% endif %}
{% endfor %}
{% endif %}
